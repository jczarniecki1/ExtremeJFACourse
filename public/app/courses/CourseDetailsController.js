// Generated by CoffeeScript 1.7.1
(function() {
  var FeedbackModalController;

  FeedbackModalController = function($scope, $modalInstance, items) {
    $scope.items = items;
    $scope.selected = {
      item: $scope.items[0]
    };
    $scope.ok = function() {
      return $modalInstance.close($scope.selected.item);
    };
    return $scope.cancel = function() {
      return $modalInstance.dismiss("cancel");
    };
  };

  angular.module('app').controller('CourseDetailsController', function($scope, CachedCourse, CachedRating, $routeParams, IdentityService, NotifierService, $location, $modal, $log) {
    var afterFetchRating, existingRating, ratingArgs, saveRating, savingRating;
    $scope.identity = IdentityService;
    existingRating = null;
    savingRating = null;
    $scope.items = ['item1', 'item2', 'item3'];
    $scope.openFeedbackModal = function(size) {
      var modalInstance;
      modalInstance = $modal.open({
        templateUrl: "/partials/bootstrap/modal/feedbackModal",
        controller: FeedbackModalController,
        size: size,
        resolve: {
          items: function() {
            return $scope.items;
          }
        }
      });
      return modalInstance.result.then(function(selectedItem) {
        return $scope.selected = selectedItem;
      }, function() {
        return $log.info("Modal dismissed at: " + new Date());
      });
    };
    $scope["delete"] = function() {
      return CachedCourse.remove($routeParams.id).then(function() {
        NotifierService.notify("Course removed successfully");
        return $location.path("/");
      }, function(error) {
        return NotifierService.error(error);
      });
    };
    CachedCourse.query().$promise.then(function(collection) {
      return collection.findById($routeParams.id, function(course) {
        return $scope.course = course;
      });
    });
    if (IdentityService.isAuthenticated()) {
      ratingArgs = {
        objectId: $routeParams.id,
        type: 'course'
      };
      $scope.isReadonly = true;
      saveRating = function() {
        if (existingRating == null) {
          ratingArgs.value = $scope.userRate;
          return CachedRating.create(ratingArgs).then(function(rating) {
            return existingRating = rating;
          });
        } else {
          existingRating.value = $scope.userRate;
          return existingRating.$update().then(function(rating) {
            return existingRating = rating;
          });
        }
      };
      $scope.hoverRating = function() {
        clearTimeout(savingRating);
        return $scope.isRatingHovered = true;
      };
      $scope.showFeedbackDialog = function() {
        return console.log("TODO: showFeedbackDialog");
      };
      $scope.leaveRating = function() {
        if (!IdentityService.currentUser.isAdmin()) {
          $scope.isRatingHovered = false;
          return savingRating = setTimeout(function() {
            if (!($scope.isRatingHovered || $scope.userRate === $scope.currentRate)) {
              $scope.userRate = $scope.currentRate;
              return saveRating();
            }
          }, 1000);
        }
      };
      afterFetchRating = function() {
        return $scope.isReadonly = false;
      };
      return CachedRating.findOne(ratingArgs).then(function(rating) {
        $scope.currentRate = $scope.userRate = rating.value;
        existingRating = rating;
        return afterFetchRating();
      }, function() {
        $scope.currentRate = $scope.userRate = 0;
        return afterFetchRating();
      });
    }
  });

}).call(this);

//# sourceMappingURL=CourseDetailsController.map
