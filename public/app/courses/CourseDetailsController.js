// Generated by CoffeeScript 1.7.1
(function() {
  angular.module('app').controller('CourseDetailsController', function($scope, CachedCourse, CachedRating, $routeParams, IdentityService, NotifierService, $location, $rootScope, $dialogs) {
    var afterFetchRating, existingRating, ratingArgs, saveRating, savingRating;
    $scope.identity = IdentityService;
    existingRating = null;
    savingRating = null;
    $scope.openFeedbackModal = function() {
      return $dialogs.create('/partials/bootstrap/modal/feedbackModal', 'FeedbackModalController', {}, {
        key: false,
        back: 'static'
      }).result.then(function(feedback) {
        console.debug("TODO: save feedback");
        return NotifierService.notify("Message submitted successfully");
      }, function() {
        return $scope.name = 'You decided not to enter in your name, that makes me sad.';
      });
    };
    $scope["delete"] = function() {
      return CachedCourse.remove($routeParams.id).then(function() {
        NotifierService.notify("Course removed successfully");
        return $location.path("/");
      }, function(error) {
        return NotifierService.error(error);
      });
    };
    CachedCourse.query().$promise.then(function(collection) {
      return collection.findById($routeParams.id, function(course) {
        return $scope.course = course;
      });
    });
    if (IdentityService.isAuthenticated()) {
      ratingArgs = {
        objectId: $routeParams.id,
        type: 'course'
      };
      $scope.isReadonly = true;
      saveRating = function() {
        if (existingRating == null) {
          ratingArgs.value = $scope.userRate;
          return CachedRating.create(ratingArgs).then(function(rating) {
            return existingRating = rating;
          });
        } else {
          existingRating.value = $scope.userRate;
          return existingRating.$update().then(function(rating) {
            return existingRating = rating;
          });
        }
      };
      $scope.hoverRating = function() {
        clearTimeout(savingRating);
        return $scope.isRatingHovered = true;
      };
      $scope.showFeedbackDialog = function() {
        return console.log("TODO: showFeedbackDialog");
      };
      $scope.leaveRating = function() {
        if (!IdentityService.currentUser.isAdmin()) {
          $scope.isRatingHovered = false;
          return savingRating = setTimeout(function() {
            if (!($scope.isRatingHovered || $scope.userRate === $scope.currentRate)) {
              $scope.userRate = $scope.currentRate;
              return saveRating();
            }
          }, 1000);
        }
      };
      afterFetchRating = function() {
        return $scope.isReadonly = false;
      };
      return CachedRating.findOne(ratingArgs).then(function(rating) {
        $scope.currentRate = $scope.userRate = rating.value;
        existingRating = rating;
        return afterFetchRating();
      }, function() {
        $scope.currentRate = $scope.userRate = 0;
        return afterFetchRating();
      });
    }
  });

}).call(this);

//# sourceMappingURL=CourseDetailsController.map
