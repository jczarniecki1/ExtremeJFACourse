// Generated by CoffeeScript 1.7.1
(function() {
  var User, passport;

  passport = require('passport');

  User = require('mongoose').model('User');

  exports.authenticate = function(req, res, next) {
    var auth, username, _ref;
    username = req.body.username = (_ref = req.body.username) != null ? _ref.toLowerCase() : void 0;
    auth = passport.authenticate('local', function(err, user) {
      if (err) {
        return next(err);
      } else if (!user) {
        return User.findOne({
          username: username
        }).exec(function(err, user) {
          if (user != null) {
            return res.send({
              success: false,
              reason: 'password'
            });
          } else {
            return res.send({
              success: false,
              reason: 'username'
            });
          }
        });
      } else {
        return req.logIn(user, function(err) {
          if (err) {
            return next(err);
          } else {
            return res.send({
              success: true,
              user: user.getData()
            });
          }
        });
      }
    });
    return auth(req, res, next);
  };

  exports.requireLogin = function(req, res, next) {
    if (!req.isAuthenticated()) {
      res.status(404);
      return res.end();
    } else {
      return next();
    }
  };

  exports.requireRole = function(role) {
    return function(req, res, next) {
      if (!(req.isAuthenticated() && req.user.hasRole(role))) {
        res.status(404);
        return res.end();
      } else {
        return next();
      }
    };
  };

  exports.logout = function(req, res) {
    req.logout();
    return res.end();
  };

}).call(this);

//# sourceMappingURL=auth.map
